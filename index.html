<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>éº»é›€ã‚¹ã‚³ã‚¢è¨˜éŒ²</title>
</head>
<body>
  <h1>éº»é›€ã‚¹ã‚³ã‚¢è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ </h1>
  <form id="scoreForm">
    <label>å¤§ä¼šå: <input name="tournament" required></label><br>
    <label>æ—¥ä»˜: <input name="date" type="date" required></label><br><br>
    
    <!-- æœ€å¤§4äººåˆ†ï¼ˆæ‹¡å¼µå¯èƒ½ï¼‰ -->
    <div id="players">
      <div>
        <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1: <input name="player1"></label>
        <label>ã‚¹ã‚³ã‚¢: <input name="score1" type="number"></label>
      </div>
      <div>
        <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2: <input name="player2"></label>
        <label>ã‚¹ã‚³ã‚¢: <input name="score2" type="number"></label>
      </div>
      <div>
        <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3: <input name="player3"></label>
        <label>ã‚¹ã‚³ã‚¢: <input name="score3" type="number"></label>
      </div>
      <div>
        <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼4: <input name="player4"></label>
        <label>ã‚¹ã‚³ã‚¢: <input name="score4" type="number"></label>
      </div>
    </div>
    <br>
    <button type="submit">é€ä¿¡</button>
  </form>

  <p id="result"></p>

  <script>
    const TOKEN = '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'; // ğŸ”’ã“ã“ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è²¼ã‚‹ï¼ˆå¾Œè¿°ï¼‰
    const USERNAME = 'nagasavva';    // GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼å
    const REPO = 'majan-result';              // ãƒªãƒã‚¸ãƒˆãƒªå
    const FILEPATH = 'scores.json';             // JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
    const BRANCH = 'main';                      // ãƒ–ãƒ©ãƒ³ãƒåï¼ˆé€šå¸¸ã¯ mainï¼‰

    document.getElementById('scoreForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const form = e.target;
      const entry = {
        tournament: form.tournament.value,
        date: form.date.value,
        players: []
      };

      for (let i = 1; i <= 20; i++) {
        const name = form[`player${i}`]?.value;
        const score = form[`score${i}`]?.value;
        if (name && score) {
          entry.players.push({ name, score: Number(score) });
        }
      }

      const apiUrl = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILEPATH}`;

      try {
        const getRes = await fetch(apiUrl, {
          headers: { Authorization: `token ${TOKEN}` }
        });
        const data = await getRes.json();
        const currentContent = JSON.parse(atob(data.content));
        currentContent.push(entry);
        const updatedContent = btoa(JSON.stringify(currentContent, null, 2));

        const res = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            Authorization: `token ${TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `ã‚¹ã‚³ã‚¢è¿½åŠ : ${entry.tournament} ${entry.date}`,
            content: updatedContent,
            sha: data.sha,
            branch: BRANCH
          })
        });

        if (res.ok) {
          document.getElementById('result').textContent = 'âœ… ã‚¹ã‚³ã‚¢ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼';
        } else {
          throw new Error(await res.text());
        }
      } catch (err) {
        console.error(err);
        document.getElementById('result').textContent = 'âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
      }
    });
  </script>
</body>
</html>
